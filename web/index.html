<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    <title>Universal Exchange</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- –•–µ–¥–µ—Ä -->
        <header class="header">
            <div class="logo">
                <i class="fas fa-exchange-alt"></i>
                <h1>Universal Exchange</h1>
            </div>
            <div class="user-info" id="userInfo">
                <i class="fas fa-user"></i>
                <span>–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
        </header>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <section class="stats-section">
            <h2><i class="fas fa-chart-line"></i> –¢–µ–∫—É—â–∏–µ –∫—É—Ä—Å—ã</h2>
            <div class="stats-grid" id="ratesContainer">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fab fa-telegram"></i>
                    </div>
                    <div class="stat-value" id="tonPrice">-- ‚ÇΩ</div>
                    <div class="stat-label">TON</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="stat-value" id="usdtPrice">-- ‚ÇΩ</div>
                    <div class="stat-label">USDT</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-value" id="usersCount">--</div>
                    <div class="stat-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                </div>
            </div>
        </section>

        <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
        <section class="actions-section">
            <h2><i class="fas fa-bolt"></i> –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h2>
            <div class="actions-grid">
                <button class="action-btn" onclick="buyTON()">
                    <i class="fab fa-telegram"></i>
                    <span>–ö—É–ø–∏—Ç—å TON</span>
                </button>
                <button class="action-btn" onclick="buyUSDT()">
                    <i class="fas fa-dollar-sign"></i>
                    <span>–ö—É–ø–∏—Ç—å USDT</span>
                </button>
                <button class="action-btn" onclick="sellCrypto()">
                    <i class="fas fa-arrow-up"></i>
                    <span>–ü—Ä–æ–¥–∞—Ç—å</span>
                </button>
                <button class="action-btn" onclick="openProducts()">
                    <i class="fas fa-shopping-cart"></i>
                    <span>–¢–æ–≤–∞—Ä—ã</span>
                </button>
            </div>
        </section>

        <!-- –ú–µ–Ω—é -->
        <section class="menu-section">
            <h2><i class="fas fa-th-large"></i> –ú–µ–Ω—é</h2>
            <div class="menu-grid">
                <a href="/profile?user_id=" class="menu-item" id="profileLink">
                    <i class="fas fa-user"></i>
                    <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
                </a>
                <a href="/exchange" class="menu-item">
                    <i class="fas fa-exchange-alt"></i>
                    <span>–û–±–º–µ–Ω</span>
                </a>
                <a href="/products" class="menu-item">
                    <i class="fas fa-shopping-bag"></i>
                    <span>–¢–æ–≤–∞—Ä—ã</span>
                </a>
                <div class="menu-item" onclick="openReferrals()">
                    <i class="fas fa-users"></i>
                    <span>–†–µ—Ñ–µ—Ä–∞–ª—ã</span>
                </div>
                <div class="menu-item" onclick="openSupport()">
                    <i class="fas fa-headset"></i>
                    <span>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</span>
                </div>
                <div class="menu-item" onclick="openHistory()">
                    <i class="fas fa-history"></i>
                    <span>–ò—Å—Ç–æ—Ä–∏—è</span>
                </div>
            </div>
        </section>

        <!-- –§—É—Ç–µ—Ä -->
        <footer class="footer">
            <p>¬© 2024 Universal Exchange. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
            <p class="footer-info">
                <i class="fas fa-shield-alt"></i> –ë–µ–∑–æ–ø–∞—Å–Ω–æ | 
                <i class="fas fa-clock"></i> 24/7 | 
                <i class="fas fa-bolt"></i> –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ
            </p>
        </footer>
    </div>

    <script src="/static/js/script.js"></script>
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        const tg = window.Telegram.WebApp;
        
        // –†–∞—Å—à–∏—Ä—è–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
        tg.expand();
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–º—É
        if (tg.colorScheme === 'dark') {
            document.body.classList.add('dark-theme');
        }
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const user = tg.initDataUnsafe?.user;
        if (user) {
            document.getElementById('userInfo').innerHTML = `
                <i class="fas fa-user"></i>
                <span>${user.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</span>
            `;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å
            const profileLink = document.getElementById('profileLink');
            profileLink.href = `/profile?user_id=${user.id}`;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            loadUserData(user.id);
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫—É—Ä—Å—ã
        loadRates();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        setInterval(loadRates, 30000);
        
        // –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function buyTON() {
            tg.showPopup({
                title: 'üíé –ü–æ–∫—É–ø–∫–∞ TON',
                message: '–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:',
                buttons: [
                    {id: 'rub', text: 'üí≥ –†—É–±–ª–∏', type: 'default'},
                    {id: 'usdt', text: 'üí∞ USDT', type: 'default'},
                    {type: 'cancel'}
                ]
            }, function(btnId) {
                if (btnId === 'rub') {
                    startPurchase('ton', 'rub');
                } else if (btnId === 'usdt') {
                    startPurchase('ton', 'usdt');
                }
            });
        }
        
        function buyUSDT() {
            tg.showPopup({
                title: 'üí∞ –ü–æ–∫—É–ø–∫–∞ USDT',
                message: '–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –≤ —Ä—É–±–ª—è—Ö:',
                buttons: [
                    {id: 'confirm', text: '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å', type: 'default'},
                    {type: 'cancel'}
                ]
            });
        }
        
        function sellCrypto() {
            tg.showPopup({
                title: 'üì§ –ü—Ä–æ–¥–∞–∂–∞',
                message: '–ß—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–∞—Ç—å?',
                buttons: [
                    {id: 'ton', text: 'üíé TON', type: 'default'},
                    {id: 'usdt', text: 'üí∞ USDT', type: 'default'},
                    {type: 'cancel'}
                ]
            });
        }
        
        function openProducts() {
            window.location.href = '/products';
        }
        
        function openReferrals() {
            tg.sendData(JSON.stringify({
                action: 'open_referrals'
            }));
        }
        
        function openSupport() {
            tg.openTelegramLink('https://t.me/salxanovka');
        }
        
        function openHistory() {
            tg.sendData(JSON.stringify({
                action: 'open_history'
            }));
        }
        
        function startPurchase(crypto, currency) {
            tg.sendData(JSON.stringify({
                action: 'start_purchase',
                crypto: crypto,
                currency: currency
            }));
        }
        
        async function loadRates() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                if (data.status === 'success') {
                    const rates = data.data.rates;
                    document.getElementById('tonPrice').textContent = 
                        parseFloat(rates.ton).toFixed(2) + ' ‚ÇΩ';
                    document.getElementById('usdtPrice').textContent = 
                        parseFloat(rates.usdt).toFixed(2) + ' ‚ÇΩ';
                    document.getElementById('usersCount').textContent = 
                        data.data.users.total;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—É—Ä—Å–æ–≤:', error);
            }
        }
        
        async function loadUserData(userId) {
            try {
                const response = await fetch(`/api/data?action=user&user_id=${userId}`);
                const data = await response.json();
                
                if (data.success) {
                    console.log('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', data.data);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –±–æ—Ç–∞
        tg.onEvent('webAppDataReceived', (event) => {
            const data = JSON.parse(event.data);
            console.log('–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ:', data);
            
            if (data.action === 'show_message') {
                tg.showPopup({
                    title: data.title || '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è',
                    message: data.message,
                    buttons: [{type: 'close'}]
                });
            }
        });
    </script>
</body>
</html>
